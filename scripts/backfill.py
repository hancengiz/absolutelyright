#!/usr/bin/env python3
import sys
from claude_counter import *


def scan_all_projects():
    compiled_patterns = {
        name: re.compile(pattern, re.IGNORECASE) for name, pattern in PATTERNS.items()
    }
    daily_counts = {name: defaultdict(int) for name in PATTERNS}
    total_counts = {name: 0 for name in PATTERNS}
    project_breakdown = defaultdict(lambda: defaultdict(int))
    total_messages_per_day = defaultdict(int)

    if not os.path.exists(CLAUDE_PROJECTS_BASE):
        print(f"Error: Projects directory not found at {CLAUDE_PROJECTS_BASE}")
        print("Set CLAUDE_PROJECTS env variable to your Claude projects path")
        return daily_counts, project_breakdown, total_messages_per_day

    print("Scanning all Claude projects...")

    for project_dir in Path(CLAUDE_PROJECTS_BASE).iterdir():
        if project_dir.is_dir() and not project_dir.name.startswith("."):
            project_name = get_project_display_name(project_dir.name)

            for jsonl_file in project_dir.glob("*.jsonl"):
                # Count all assistant messages
                try:
                    with open(jsonl_file, "r") as f:
                        for line in f:
                            try:
                                entry = json.loads(line)
                                if entry.get("type") == "assistant":
                                    timestamp = entry.get("timestamp", "")
                                    if timestamp:
                                        entry_time = datetime.fromisoformat(
                                            timestamp.replace("Z", "+00:00")
                                        )
                                        date_str = entry_time.strftime("%Y-%m-%d")
                                    else:
                                        date_str = get_utc_today()
                                    total_messages_per_day[date_str] += 1
                            except:
                                continue
                except:
                    pass

                # Count pattern matches
                matches = scan_jsonl_file(
                    jsonl_file, set(), project_name, compiled_patterns
                )

                for match in matches:
                    for pattern_name in match["matches"]:
                        daily_counts[pattern_name][match["date"]] += 1
                        total_counts[pattern_name] += 1
                        if pattern_name == "absolutely":
                            project_breakdown[match["date"]][project_name] += 1

    for name, count in total_counts.items():
        unique_days = len(daily_counts[name])
        print(f"Found {count} '{name}' across {unique_days} days")

    return daily_counts, project_breakdown, total_messages_per_day


def main():
    """Main backfill process"""
    print("Claude Pattern Counter Backfill")
    print("=" * 50)

    # Check for upload parameters
    api_url = None
    secret = None

    for i, arg in enumerate(sys.argv):
        if arg == "--upload" and i + 2 < len(sys.argv):
            api_url = sys.argv[i + 1]
            secret = sys.argv[i + 2]
            break
        elif arg == "--upload" and i + 1 < len(sys.argv):
            api_url = sys.argv[i + 1]
            break

    # Show current settings
    print(f"Projects directory: {CLAUDE_PROJECTS_BASE}")
    print("Tracking patterns:")
    for name, pattern in PATTERNS.items():
        print(f"  {name}: {pattern}")
    if api_url:
        print(f"Will upload to: {api_url}")
    print("-" * 50)

    # Scan all projects
    daily_counts, project_breakdown, total_messages_per_day = scan_all_projects()

    if not any(daily_counts.values()):
        print("No data found.")
        return

    # Get all dates that have any data
    all_dates = set()
    for pattern_counts in daily_counts.values():
        all_dates.update(pattern_counts.keys())
    sorted_dates = sorted(all_dates)

    print("\nDaily counts:")
    print("-" * 80)

    # Output format based on arguments
    if "--json" in sys.argv:
        # JSON output for piping to other tools
        output = {pattern: dict(counts) for pattern, counts in daily_counts.items()}
        output["by_date"] = {
            date: dict(project_breakdown[date])
            for date in sorted_dates
            if date in project_breakdown
        }
        print(json.dumps(output, indent=2))
    else:
        # Human-readable output
        for date in sorted_dates:
            abs_count = daily_counts["absolutely"].get(date, 0)
            right_count = daily_counts["right"].get(date, 0)
            total_msgs = total_messages_per_day.get(date, 0)
            projects = project_breakdown.get(date, {})

            project_info = ""
            if len(projects) == 1:
                project_info = f" (in {list(projects.keys())[0]})"
            elif len(projects) > 1:
                # Find project with highest count
                top_project = max(projects.items(), key=lambda x: x[1])[0]
                other_count = len(projects) - 1
                if other_count == 1:
                    project_info = f" (in {top_project} and 1 other project)"
                else:
                    project_info = (
                        f" (in {top_project} and {other_count} other projects)"
                    )

            print(
                f"{date}: absolutely={abs_count:3d}, right={right_count:3d}, total={total_msgs:3d}{project_info}"
            )

        print("-" * 50)
        print(f"Total 'absolutely right': {sum(daily_counts['absolutely'].values())}")
        print(f"Total 'right': {sum(daily_counts['right'].values())}")

        # Upload to API if requested (only absolutely and right for now)
        if api_url:
            print("\n" + "-" * 50)
            total_to_upload = sum(
                1
                for date in sorted_dates
                if daily_counts["absolutely"].get(date, 0) > 0
                or daily_counts["right"].get(date, 0) > 0
            )

            print(f"Found {total_to_upload} days with data to upload.")
            confirm = input("Continue with upload? (y/N): ").strip().lower()
            if confirm not in ["y", "yes"]:
                print("Upload cancelled.")
                return

            print("Uploading to API...")
            success = 0
            failed = 0

            for date in sorted_dates:
                abs_count = daily_counts["absolutely"].get(date, 0)
                right_count = daily_counts["right"].get(date, 0)
                total_msgs = total_messages_per_day.get(date, 0)

                if abs_count > 0 or right_count > 0:
                    upload_text = f"  Uploading {date}: absolutely={abs_count:2d}, right={right_count:2d}, total={total_msgs:3d}..."
                    print(f"{upload_text:<75}", end="")

                    result = upload_to_api(
                        api_url, secret, date, abs_count, right_count, total_msgs
                    )
                    if result == True:
                        print("✓")
                        success += 1
                    elif result == "STOP":
                        print("✗")
                        failed += 1
                        break
                    else:
                        print("✗")
                        failed += 1

            print("-" * 50)
            print(f"Upload complete: {success} successful, {failed} failed")
            if success > 0:
                print(f"View at: {api_url}")


if __name__ == "__main__":
    main()
